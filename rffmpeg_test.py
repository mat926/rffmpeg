import os
from importlib.util import spec_from_loader, module_from_spec
from importlib.machinery import SourceFileLoader

# Get the full path of the current script's directory
current_dir = os.path.dirname(os.path.abspath(__file__))

spec = spec_from_loader("rffmpeg", SourceFileLoader("rffmpeg",  os.path.join(current_dir, "rffmpeg")))
rffmpeg = module_from_spec(spec)
spec.loader.exec_module(rffmpeg)


def test_translate_harware_acceleration_args_1():
    "inside out , truehd audio , english psub, from begining"

    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '52165686', '-maxrate', '52165686', '-bufsize', '104331372', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=3840:h=2160'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '1983afd2f7554c7ddf52d3cc4715e521-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/1983afd2f7554c7ddf52d3cc4715e521%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/1983afd2f7554c7ddf52d3cc4715e521.m3u8']

    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '52165686', '-maxrate', '52165686', '-bufsize', '104331372', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'e69baad9d50f02e8c61a2133e0adf33f-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/e69baad9d50f02e8c61a2133e0adf33f%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/e69baad9d50f02e8c61a2133e0adf33f.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

    
def test_translate_harware_acceleration_args_2():
    "inside out , truehd audio , english psub, from begining - no Hardware accelaration "
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '52165686', '-maxrate', '52165686', '-bufsize', '104331372', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale=trunc(min(max(iw\\,ih*a)\\,min(3840\\,2160*a))/2)*2:trunc(min(max(iw/a\\,ih)\\,min(3840/a\\,2160))/2)*2,format=yuv420p[main];[main][sub]overlay=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '47510335ee2cb1746925501677382041-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/47510335ee2cb1746925501677382041%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/47510335ee2cb1746925501677382041.m3u8']
    expected = None #Unknown
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_3():
    "inside out , truehd audio , no sub, from beginning"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '52165686', '-maxrate', '52165686', '-bufsize', '104331372', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '799ed512c6c95b86c596b7f04568a46e-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/799ed512c6c95b86c596b7f04568a46e%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/799ed512c6c95b86c596b7f04568a46e.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '52165686', '-maxrate', '52165686', '-bufsize', '104331372', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '43602a00a7a24e26e113d93676cdf761-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/43602a00a7a24e26e113d93676cdf761%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/43602a00a7a24e26e113d93676cdf761.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_4():
    "inside out , aac audio , no sub, from beginning"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:2', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '52165686', '-maxrate', '52165686', '-bufsize', '104331372', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '934864212e054a033508fcd4a4c70652-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/934864212e054a033508fcd4a4c70652%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/934864212e054a033508fcd4a4c70652.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:2', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '52165686', '-maxrate', '52165686', '-bufsize', '104331372', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '319a4c74888aa2af9478ad788f2001f2-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/319a4c74888aa2af9478ad788f2001f2%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/319a4c74888aa2af9478ad788f2001f2.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

        
def test_translate_harware_acceleration_args_26():
    "inside out , aac audio , pgsub, from beginning"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:2', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '52165686', '-maxrate', '52165686', '-bufsize', '104331372', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=3840:h=2160'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '867f7954ff9be0fa1f9f3f482049e385-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/867f7954ff9be0fa1f9f3f482049e385%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/867f7954ff9be0fa1f9f3f482049e385.m3u8']

    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:2', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '52165686', '-maxrate', '52165686', '-bufsize', '104331372', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '1babbb1493b939062e9c92bddf1e1d53-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/1babbb1493b939062e9c92bddf1e1d53%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/1babbb1493b939062e9c92bddf1e1d53.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_5():
    "her, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', '"file:/media/movies/Her (2013)/Her (2013) [imdbid-tt1798709] - [Remux-1080p][DTS-HD MA 5.1][AVC]-FraMeSToR.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-bsf:v', 'h264_mp4toannexb', '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'cbf314b529746b8d571402c9987a81a4-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/cbf314b529746b8d571402c9987a81a4%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/cbf314b529746b8d571402c9987a81a4.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', '"file:/media/movies/Her (2013)/Her (2013) [imdbid-tt1798709] - [Remux-1080p][DTS-HD MA 5.1][AVC]-FraMeSToR.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-bsf:v', 'h264_mp4toannexb', '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'f51773330eff804d52ca829055f91109-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/f51773330eff804d52ca829055f91109%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/f51773330eff804d52ca829055f91109.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

def test_translate_harware_acceleration_args_27():
    "her, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Her (2013)/Her (2013) [imdbid-tt1798709] - [Remux-1080p][DTS-HD MA 5.1][AVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '27825408', '-maxrate', '27825408', '-bufsize', '55650816', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:2]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=1920:h=1080'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '08b8b3bc2dc7b99dfa6eeabbdfaf5d20-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/08b8b3bc2dc7b99dfa6eeabbdfaf5d20%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/08b8b3bc2dc7b99dfa6eeabbdfaf5d20.m3u8']
    expected =['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Her (2013)/Her (2013) [imdbid-tt1798709] - [Remux-1080p][DTS-HD MA 5.1][AVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '27825408', '-maxrate', '27825408', '-bufsize', '55650816', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:2]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '0952f44da7cafc88dd2ae77b29628c47-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/0952f44da7cafc88dd2ae77b29628c47%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/0952f44da7cafc88dd2ae77b29628c47.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_6():
    "her, 720p 8mbps, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Her (2013)/Her (2013) [imdbid-tt1798709] - [Remux-1080p][DTS-HD MA 5.1][AVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '7616000', '-maxrate', '7616000', '-bufsize', '15232000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '578d61150dc1d5cb8c42e97079428111-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/578d61150dc1d5cb8c42e97079428111%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/578d61150dc1d5cb8c42e97079428111.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Her (2013)/Her (2013) [imdbid-tt1798709] - [Remux-1080p][DTS-HD MA 5.1][AVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '7616000', '-maxrate', '7616000', '-bufsize', '15232000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '97374bbcae4bacf3ba83757993b4ae93-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/97374bbcae4bacf3ba83757993b4ae93%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/97374bbcae4bacf3ba83757993b4ae93.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_28():
    "her, 720p 8mbps, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Her (2013)/Her (2013) [imdbid-tt1798709] - [Remux-1080p][DTS-HD MA 5.1][AVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '7616000', '-maxrate', '7616000', '-bufsize', '15232000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:2]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=1920:h=1080'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '1ae3bc0599a758686e0b4b0f630d270a-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/1ae3bc0599a758686e0b4b0f630d270a%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/1ae3bc0599a758686e0b4b0f630d270a.m3u8']

    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Her (2013)/Her (2013) [imdbid-tt1798709] - [Remux-1080p][DTS-HD MA 5.1][AVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '7616000', '-maxrate', '7616000', '-bufsize', '15232000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:2]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '1225bf40d9252306673fcab4125eb0a5-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/1225bf40d9252306673fcab4125eb0a5%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/1225bf40d9252306673fcab4125eb0a5.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_7():
    "her, 360p - 420kbps, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Her (2013)/Her (2013) [imdbid-tt1798709] - [Remux-1080p][DTS-HD MA 5.1][AVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=w=426:h=240:format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'e3c01d98b79752bdfe976866ad3a699c-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/e3c01d98b79752bdfe976866ad3a699c%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/e3c01d98b79752bdfe976866ad3a699c.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Her (2013)/Her (2013) [imdbid-tt1798709] - [Remux-1080p][DTS-HD MA 5.1][AVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=240:format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '18601151fb9e852ff5c8829557f671d9-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/18601151fb9e852ff5c8829557f671d9%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/18601151fb9e852ff5c8829557f671d9.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_8():
    "hello love goodbye , seek 01:05:09.292"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-ss', '01:04:45.750', '-noaccurate_seek', '-fflags', '+genpts', '-i', '"file:/media/movies/Hello Love Goodbye (2019) [imdbid-tt10156112]/Hello Love Goodbye (2019) [imdbid-tt10156112] - [WEBDL-1080p][AAC 2.0][HEVC]-SH3LBY.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-tag:v:0', 'hvc1', '-bsf:v', 'hevc_mp4toannexb', '-start_at_zero', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '9ea9a4ff2cb4212cdd7ae72604d25c3b-1.mp4', '-start_number', '647', '-hls_segment_filename', '/cache/transcodes/9ea9a4ff2cb4212cdd7ae72604d25c3b%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/9ea9a4ff2cb4212cdd7ae72604d25c3b.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-ss', '01:05:24.750', '-noaccurate_seek', '-fflags', '+genpts', '-i', '"file:/media/movies/Hello Love Goodbye (2019) [imdbid-tt10156112]/Hello Love Goodbye (2019) [imdbid-tt10156112] - [WEBDL-1080p][AAC 2.0][HEVC]-SH3LBY.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-tag:v:0', 'hvc1', '-bsf:v', 'hevc_mp4toannexb', '-start_at_zero', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'a0855b1bbb1529a673b04ab45dbc9367-1.mp4', '-start_number', '654', '-hls_segment_filename', '/cache/transcodes/a0855b1bbb1529a673b04ab45dbc9367%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/a0855b1bbb1529a673b04ab45dbc9367.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_9():
    "hello love goodbye, from beggining subrip"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', '"file:/media/movies/Hello Love Goodbye (2019) [imdbid-tt10156112]/Hello Love Goodbye (2019) [imdbid-tt10156112] - [WEBDL-1080p][AAC 2.0][HEVC]-SH3LBY.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-tag:v:0', 'hvc1', '-bsf:v', 'hevc_mp4toannexb', '-start_at_zero', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'ec1c4223feaaf4ca9c0aa9c8d3be323e-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/ec1c4223feaaf4ca9c0aa9c8d3be323e%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/ec1c4223feaaf4ca9c0aa9c8d3be323e.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', '"file:/media/movies/Hello Love Goodbye (2019) [imdbid-tt10156112]/Hello Love Goodbye (2019) [imdbid-tt10156112] - [WEBDL-1080p][AAC 2.0][HEVC]-SH3LBY.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-tag:v:0', 'hvc1', '-bsf:v', 'hevc_mp4toannexb', '-start_at_zero', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '8a9b82d0b6a8e39c54d78ae26539e2d5-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/8a9b82d0b6a8e39c54d78ae26539e2d5%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/8a9b82d0b6a8e39c54d78ae26539e2d5.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_10():
    "hello love goodbye, from beggining no sub (direct play)"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', '"file:/media/movies/Hello Love Goodbye (2019) [imdbid-tt10156112]/Hello Love Goodbye (2019) [imdbid-tt10156112] - [WEBDL-1080p][AAC 2.0][HEVC]-SH3LBY.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-tag:v:0', 'hvc1', '-bsf:v', 'hevc_mp4toannexb', '-start_at_zero', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '952fc809e87a2f862f12f0f275192acd-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/952fc809e87a2f862f12f0f275192acd%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/952fc809e87a2f862f12f0f275192acd.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', '"file:/media/movies/Hello Love Goodbye (2019) [imdbid-tt10156112]/Hello Love Goodbye (2019) [imdbid-tt10156112] - [WEBDL-1080p][AAC 2.0][HEVC]-SH3LBY.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-tag:v:0', 'hvc1', '-bsf:v', 'hevc_mp4toannexb', '-start_at_zero', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '4b4f6960d00c19f829d53f72ba88b045-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/4b4f6960d00c19f829d53f72ba88b045%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/4b4f6960d00c19f829d53f72ba88b045.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_11():
    "mag ingat ka sa kulam , from beginning, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-noautorotate', '-i', '"file:/media/movies/Mag-ingat ka sa. Kulam (2008)/Mag-ingat ka sa. Kulam (2008) [imdbid-tt1071223] - [DVD][MP3 2.0][DivX].avi"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '5619176', '-maxrate', '5619176', '-bufsize', '11238352', '-g:v:0', '90', '-keyint_min:v:0', '90', '-vf', "'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale=trunc(min(max(iw\\,ih*a)\\,min(720\\,480*a))/2)*2:trunc(min(max(iw/a\\,ih)\\,min(720/a\\,480))/2)*2,format=yuv420p'", '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'eac5a368a2a8df4e7aa907439ad71de9-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/eac5a368a2a8df4e7aa907439ad71de9%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/eac5a368a2a8df4e7aa907439ad71de9.m3u8']

    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Mag-ingat ka sa. Kulam (2008)/Mag-ingat ka sa. Kulam (2008) [imdbid-tt1071223] - [DVD][MP3 2.0][DivX].avi"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '5619176', '-maxrate', '5619176', '-bufsize', '11238352', '-g:v:0', '90', '-keyint_min:v:0', '90', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '4a82aa7fd8981333a3cb620ac053b0a8-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/4a82aa7fd8981333a3cb620ac053b0a8%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/4a82aa7fd8981333a3cb620ac053b0a8.m3u8']

    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_12():
    "mag ingat ka sa kulam , from beginning, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-noautorotate', '-i', '"file:/media/movies/Mag-ingat ka sa. Kulam (2008)/Mag-ingat ka sa. Kulam (2008) [imdbid-tt1071223] - [DVD][MP3 2.0][DivX].avi"', '-i', '"file:/media/movies/Mag-ingat ka sa. Kulam (2008)/Mag-ingat ka sa. Kulam (2008) [imdbid-tt1071223] - [DVD][MP3 2.0][DivX].sub"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '1:0', '-sn', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '5619176', '-maxrate', '5619176', '-bufsize', '11238352', '-g:v:0', '90', '-keyint_min:v:0', '90', '-filter_complex', '"[1:0]scale=-1:480:fast_bilinear,scale,crop,pad=max(720\\,iw):max(480\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=720:480[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale=trunc(min(max(iw\\,ih*a)\\,min(720\\,480*a))/2)*2:trunc(min(max(iw/a\\,ih)\\,min(720/a\\,480))/2)*2,format=yuv420p[main];[main][sub]overlay=eof_action=pass:repeatlast=0"', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '86fec5fe19bccb76c0c2bf96fa7e1055-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/86fec5fe19bccb76c0c2bf96fa7e1055%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/86fec5fe19bccb76c0c2bf96fa7e1055.m3u8']

    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Mag-ingat ka sa. Kulam (2008)/Mag-ingat ka sa. Kulam (2008) [imdbid-tt1071223] - [DVD][MP3 2.0][DivX].avi"', '-i', '"file:/media/movies/Mag-ingat ka sa. Kulam (2008)/Mag-ingat ka sa. Kulam (2008) [imdbid-tt1071223] - [DVD][MP3 2.0][DivX].sub"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '1:0', '-sn', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '5619176', '-maxrate', '5619176', '-bufsize', '11238352', '-g:v:0', '90', '-keyint_min:v:0', '90', '-filter_complex', "'[1:0]scale=-1:480:fast_bilinear,scale,crop,pad=max(720\\,iw):max(480\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=720:480,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '972e22514d1dd27e97348ce0f61baf9f-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/972e22514d1dd27e97348ce0f61baf9f%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/972e22514d1dd27e97348ce0f61baf9f.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_13():
    "bean, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', 'file:/media/movies/Bean', "'(1997)'", "'[imdbid-tt0118689]/Bean'", "'(1997)'", "'[imdbid-tt0118689]'", '-', "'[Remux-1080p][DTS-HD'", 'MA', "'5.1][VC1]-SiCFoI.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '35342324', '-maxrate', '35342324', '-bufsize', '70684648', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '328008628ad6cd2f13036d7c93110d71-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/328008628ad6cd2f13036d7c93110d71%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/328008628ad6cd2f13036d7c93110d71.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Bean', "'(1997)'", "'[imdbid-tt0118689]/Bean'", "'(1997)'", "'[imdbid-tt0118689]'", '-', "'[Remux-1080p][DTS-HD'", 'MA', "'5.1][VC1]-SiCFoI.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '35342324', '-maxrate', '35342324', '-bufsize', '70684648', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '328008628ad6cd2f13036d7c93110d71-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/328008628ad6cd2f13036d7c93110d71%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/328008628ad6cd2f13036d7c93110d71.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

    
def test_translate_harware_acceleration_args_14():
    "bean, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Bean (1997) [imdbid-tt0118689]/Bean (1997) [imdbid-tt0118689] - [Remux-1080p][DTS-HD MA 5.1][VC1]-SiCFoI.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '35342324', '-maxrate', '35342324', '-bufsize', '70684648', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:2]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=1920:h=1080'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '85f37ec2eeebac6d245a1e3fa6379fab-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/85f37ec2eeebac6d245a1e3fa6379fab%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/85f37ec2eeebac6d245a1e3fa6379fab.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Bean (1997) [imdbid-tt0118689]/Bean (1997) [imdbid-tt0118689] - [Remux-1080p][DTS-HD MA 5.1][VC1]-SiCFoI.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '35342324', '-maxrate', '35342324', '-bufsize', '70684648', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:2]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '85f37ec2eeebac6d245a1e3fa6379fab-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/85f37ec2eeebac6d245a1e3fa6379fab%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/85f37ec2eeebac6d245a1e3fa6379fab.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_15():
    "cinema paradiso, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Cinema Paradiso (1988)/Cinema Paradiso (1988) [imdbid-tt0095765] - Theatrical Cut [Remux-2160p][HDR10][DTS-HD MA 5.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '93145521', '-maxrate', '93145521', '-bufsize', '186291042', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '744877247b05cb916ab624b1483921c1-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/744877247b05cb916ab624b1483921c1%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/744877247b05cb916ab624b1483921c1.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Cinema Paradiso (1988)/Cinema Paradiso (1988) [imdbid-tt0095765] - Theatrical Cut [Remux-2160p][HDR10][DTS-HD MA 5.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '93145521', '-maxrate', '93145521', '-bufsize', '186291042', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '3b9a6121c37fcc05a0202a49cce3db6a-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/3b9a6121c37fcc05a0202a49cce3db6a%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/3b9a6121c37fcc05a0202a49cce3db6a.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_16():
    "cinema paradiso, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Cinema Paradiso (1988)/Cinema Paradiso (1988) [imdbid-tt0095765] - Theatrical Cut [Remux-2160p][HDR10][DTS-HD MA 5.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '93145521', '-maxrate', '93145521', '-bufsize', '186291042', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=3840:h=2160'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '10f7d690c1f6e0953957c5bcd35ebe3c-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/10f7d690c1f6e0953957c5bcd35ebe3c%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/10f7d690c1f6e0953957c5bcd35ebe3c.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Cinema Paradiso (1988)/Cinema Paradiso (1988) [imdbid-tt0095765] - Theatrical Cut [Remux-2160p][HDR10][DTS-HD MA 5.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '93145521', '-maxrate', '93145521', '-bufsize', '186291042', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\,iw):max(2160\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '10f7d690c1f6e0953957c5bcd35ebe3c-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/10f7d690c1f6e0953957c5bcd35ebe3c%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/10f7d690c1f6e0953957c5bcd35ebe3c.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

def test_translate_harware_acceleration_args_28():
    "luca, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Luca (2021) [imdbid-tt12801262]/Luca (2021) [imdbid-tt12801262] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '59446607', '-maxrate', '59446607', '-bufsize', '118893214', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '6914113ba75357ac2a720617a2dd54e0-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/6914113ba75357ac2a720617a2dd54e0%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/6914113ba75357ac2a720617a2dd54e0.m3u8']

    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Luca (2021) [imdbid-tt12801262]/Luca (2021) [imdbid-tt12801262] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '59446607', '-maxrate', '59446607', '-bufsize', '118893214', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '07636e848dec1e2d3c01e96d28682722-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/07636e848dec1e2d3c01e96d28682722%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/07636e848dec1e2d3c01e96d28682722.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

def test_translate_harware_acceleration_args_17():
    "luca, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Luca (2021) [imdbid-tt12801262]/Luca (2021) [imdbid-tt12801262] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '59446607', '-maxrate', '59446607', '-bufsize', '118893214', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=3840:h=2160'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '8cbb6e9215e0d94ac70d21d0e0cd379b-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/8cbb6e9215e0d94ac70d21d0e0cd379b%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/d0ea8675ca9c0e96214a072ee2b2ff50.m3u8']
    #do not change this, it is the expected result
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Luca (2021) [imdbid-tt12801262]/Luca (2021) [imdbid-tt12801262] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '59446607', '-maxrate', '59446607', '-bufsize', '118893214', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '8cbb6e9215e0d94ac70d21d0e0cd379b-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/8cbb6e9215e0d94ac70d21d0e0cd379b%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/d0ea8675ca9c0e96214a072ee2b2ff50.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_18():
    "luca 1080p 60mbps, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Luca (2021) [imdbid-tt12801262]/Luca (2021) [imdbid-tt12801262] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '59446607', '-maxrate', '59446607', '-bufsize', '118893214', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=3840:h=2160'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '10ddb9c0a7a53192c0b7fe5425ba8ec9-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/10ddb9c0a7a53192c0b7fe5425ba8ec9%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/10ddb9c0a7a53192c0b7fe5425ba8ec9.m3u8']

    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Luca (2021) [imdbid-tt12801262]/Luca (2021) [imdbid-tt12801262] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '59446607', '-maxrate', '59446607', '-bufsize', '118893214', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '10ddb9c0a7a53192c0b7fe5425ba8ec9-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/10ddb9c0a7a53192c0b7fe5425ba8ec9%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/10ddb9c0a7a53192c0b7fe5425ba8ec9.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_19():
    "letters to juliet (direct play)"
    input_args = None #there was none- double check
    expected = None #there was none
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_20():
    "letters to juliet 320p"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Letters to Juliet (2010) [imdbid-tt0892318]/Letters to Juliet (2010) [imdbid-tt0892318] - [Bluray-1080p][AAC 2.0][x264]-1080p.mp4"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '324063', '-maxrate', '324063', '-bufsize', '648126', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=w=426:h=180:format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'ae06a5a3b1ff5df87e813f857aa7c13b-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/ae06a5a3b1ff5df87e813f857aa7c13b%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/ae06a5a3b1ff5df87e813f857aa7c13b.m3u8']
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Letters to Juliet (2010) [imdbid-tt0892318]/Letters to Juliet (2010) [imdbid-tt0892318] - [Bluray-1080p][AAC 2.0][x264]-1080p.mp4"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '324063', '-maxrate', '324063', '-bufsize', '648126', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=180:format=yuv420p', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '886dcc2a312fdde828d6120d4e9fe166-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/886dcc2a312fdde828d6120d4e9fe166%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/886dcc2a312fdde828d6120d4e9fe166.m3u8']
    expected = None #unknown
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_21():
    "cube 320p, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Cube (1997)/Cube (1997) [imdbid-tt0123755] - [Remux-1080p][TrueHD 5.1][AVC]-KRaLiMaRKo.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=w=426:h=240:format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'fcc80b0ad3ca15c54d15ce73110b653d-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/fcc80b0ad3ca15c54d15ce73110b653d%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/fcc80b0ad3ca15c54d15ce73110b653d.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Cube (1997)/Cube (1997) [imdbid-tt0123755] - [Remux-1080p][TrueHD 5.1][AVC]-KRaLiMaRKo.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=240:format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'fc6f51469cdbab924fb9d453e4cdf601-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/fc6f51469cdbab924fb9d453e4cdf601%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/fc6f51469cdbab924fb9d453e4cdf601.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_22():
    "cube 360p, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Cube (1997)/Cube (1997) [imdbid-tt0123755] - [Remux-1080p][TrueHD 5.1][AVC]-KRaLiMaRKo.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:240:fast_bilinear,scale,crop,pad=max(426\\,iw):max(240\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=426:240,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=w=426:h=240:format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=426:h=240'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '1933381df574f5139a399cd50631c2e6-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/1933381df574f5139a399cd50631c2e6%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/1933381df574f5139a399cd50631c2e6.m3u8']

    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Cube (1997)/Cube (1997) [imdbid-tt0123755] - [Remux-1080p][TrueHD 5.1][AVC]-KRaLiMaRKo.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:240:fast_bilinear,scale,crop,pad=max(426\\,iw):max(240\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=426:240,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=240:format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '1933381df574f5139a399cd50631c2e6-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/1933381df574f5139a399cd50631c2e6%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/1933381df574f5139a399cd50631c2e6.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_23():
    "cube, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', '"file:/media/movies/Cube (1997)/Cube (1997) [imdbid-tt0123755] - [Remux-1080p][TrueHD 5.1][AVC]-KRaLiMaRKo.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-bsf:v', 'h264_mp4toannexb', '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '46fdd578b898933014ba90b3088a63ae-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/a6073b343ae3dd0c767be694f31f5bf1%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/a6073b343ae3dd0c767be694f31f5bf1.m3u8']
    
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', '"file:/media/movies/Cube (1997)/Cube (1997) [imdbid-tt0123755] - [Remux-1080p][TrueHD 5.1][AVC]-KRaLiMaRKo.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-bsf:v', 'h264_mp4toannexb', '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '46fdd578b898933014ba90b3088a63ae-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/a6073b343ae3dd0c767be694f31f5bf1%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/a6073b343ae3dd0c767be694f31f5bf1.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_24():
    "cube ,english pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Cube (1997)/Cube (1997) [imdbid-tt0123755] - [Remux-1080p][TrueHD 5.1][AVC]-KRaLiMaRKo.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '36401060', '-maxrate', '36401060', '-bufsize', '72802120', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=1920:h=1080'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '9a2232355eeb9909eb037a9a20aa4c7e-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/9a2232355eeb9909eb037a9a20aa4c7e%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/9a2232355eeb9909eb037a9a20aa4c7e.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Cube (1997)/Cube (1997) [imdbid-tt0123755] - [Remux-1080p][TrueHD 5.1][AVC]-KRaLiMaRKo.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '36401060', '-maxrate', '36401060', '-bufsize', '72802120', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '9a2232355eeb9909eb037a9a20aa4c7e-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/9a2232355eeb9909eb037a9a20aa4c7e%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/9a2232355eeb9909eb037a9a20aa4c7e.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_25():
    "cube ,japanese pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Cube (1997)/Cube (1997) [imdbid-tt0123755] - [Remux-1080p][TrueHD 5.1][AVC]-KRaLiMaRKo.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '36401060', '-maxrate', '36401060', '-bufsize', '72802120', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:6]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=1920:h=1080'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'b4ddf52da1cef821d4f1ab891bcdcc4e-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/b4ddf52da1cef821d4f1ab891bcdcc4e%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/b4ddf52da1cef821d4f1ab891bcdcc4e.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Cube (1997)/Cube (1997) [imdbid-tt0123755] - [Remux-1080p][TrueHD 5.1][AVC]-KRaLiMaRKo.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '36401060', '-maxrate', '36401060', '-bufsize', '72802120', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:6]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'b4ddf52da1cef821d4f1ab891bcdcc4e-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/b4ddf52da1cef821d4f1ab891bcdcc4e%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/b4ddf52da1cef821d4f1ab891bcdcc4e.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

    #todo lightyear

def test_translate_harware_acceleration_args_30():
    "lightyear,pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Lightyear (2022) [imdbid-tt10298810]/Lightyear (2022) [imdbid-tt10298810] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-Flights.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '49411999', '-maxrate', '49411999', '-bufsize', '98823998', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=3840:h=2160'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '843eaee4c893f51aeda8b97f531032db-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/843eaee4c893f51aeda8b97f531032db%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/843eaee4c893f51aeda8b97f531032db.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Lightyear (2022) [imdbid-tt10298810]/Lightyear (2022) [imdbid-tt10298810] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-Flights.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '49411999', '-maxrate', '49411999', '-bufsize', '98823998', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'f95437488c293eb135eb81b1c24a38af-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/f95437488c293eb135eb81b1c24a38af%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/f95437488c293eb135eb81b1c24a38af.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
def test_translate_harware_acceleration_args_30():
    "lightyear, 1080p 60mbps pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Lightyear (2022) [imdbid-tt10298810]/Lightyear (2022) [imdbid-tt10298810] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-Flights.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '49411999', '-maxrate', '49411999', '-bufsize', '98823998', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=3840:h=2160'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '1d681b4c365274d1e18217d1b285d944-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/1d681b4c365274d1e18217d1b285d944%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/1d681b4c365274d1e18217d1b285d944.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Lightyear (2022) [imdbid-tt10298810]/Lightyear (2022) [imdbid-tt10298810] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-Flights.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '49411999', '-maxrate', '49411999', '-bufsize', '98823998', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '8db82d11ed3d2ef622ea30cabc4d36c0-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/8db82d11ed3d2ef622ea30cabc4d36c0%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/8db82d11ed3d2ef622ea30cabc4d36c0.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

def test_translate_harware_acceleration_args_26():
    "misc"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-dump_attachment:t', '-y', '-i', 'file:/media/movies/Cinema', 'Paradiso', "'(1988)/Cinema'", 'Paradiso', "'(1988)'", "'[imdbid-tt0095765]'", '-', 'Theatrical', 'Cut', "'[Remux-2160p][HDR10][DTS-HD'", 'MA', "'5.1][HEVC]-FraMeSToR.mkv'", '-t', '0', '-f', 'null', 'null']
    expected = None #Unknown
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
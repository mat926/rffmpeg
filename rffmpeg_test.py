import os
from importlib.util import spec_from_loader, module_from_spec
from importlib.machinery import SourceFileLoader

# Get the full path of the current script's directory
current_dir = os.path.dirname(os.path.abspath(__file__))

spec = spec_from_loader("rffmpeg", SourceFileLoader("rffmpeg",  os.path.join(current_dir, "rffmpeg")))
rffmpeg = module_from_spec(spec)
spec.loader.exec_module(rffmpeg)


def test_translate_harware_acceleration_args_1():
    "inside out , truehd audio , english psub, from begining"

    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:240:fast_bilinear,scale,crop,pad=max(426\\,iw):max(240\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=426:240,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=426:h=240'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '22c599ea79de13fd55c3b5755e90bb4d-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/22c599ea79de13fd55c3b5755e90bb4d%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/22c599ea79de13fd55c3b5755e90bb4d.m3u8']

    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:240:fast_bilinear,scale,crop,pad=max(426\\,iw):max(240\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=426:240,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=240:format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '22c599ea79de13fd55c3b5755e90bb4d-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/22c599ea79de13fd55c3b5755e90bb4d%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/22c599ea79de13fd55c3b5755e90bb4d.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

    
def test_translate_harware_acceleration_args_2():
    "inside out , truehd audio , english psub, from begining - no Hardware accelaration "
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '52165686', '-maxrate', '52165686', '-bufsize', '104331372', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale=trunc(min(max(iw\\,ih*a)\\,min(3840\\,2160*a))/2)*2:trunc(min(max(iw/a\\,ih)\\,min(3840/a\\,2160))/2)*2,format=yuv420p[main];[main][sub]overlay=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '47510335ee2cb1746925501677382041-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/47510335ee2cb1746925501677382041%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/47510335ee2cb1746925501677382041.m3u8']
    expected = None #Unknown
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_3():
    "inside out , truehd audio , no sub, from beginning"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=w=426:h=240:format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '970234d614e0a914d3b8156663b3a4b6-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/970234d614e0a914d3b8156663b3a4b6%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/970234d614e0a914d3b8156663b3a4b6.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Inside Out (2015) [imdbid-tt2096673]/Inside Out (2015) [imdbid-tt2096673] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=240:format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '970234d614e0a914d3b8156663b3a4b6-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/970234d614e0a914d3b8156663b3a4b6%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/970234d614e0a914d3b8156663b3a4b6.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_4():
    "inside out , aac audio , no sub, from beginning"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', 'file:/media/movies/Inside', 'Out', "'(2015)'", "'[imdbid-tt2096673]/Inside'", 'Out', "'(2015)'", "'[imdbid-tt2096673]'", '-', "'[Remux-2160p][DV'", "'HDR10][TrueHD'", 'Atmos', "'7.1][HEVC]-FraMeSToR.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:2', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=w=426:h=240:format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '83efdcbfa6521895012d2930eeb98d73-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/83efdcbfa6521895012d2930eeb98d73%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/83efdcbfa6521895012d2930eeb98d73.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Her', "'(2013)/Her'", "'(2013)'", "'[imdbid-tt1798709]'", '-', "'[Remux-1080p][DTS-HD'", 'MA', "'5.1][AVC]-FraMeSToR.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=240:format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '7ed0e8eef79b8b08efda8152bd5c5595-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/7ed0e8eef79b8b08efda8152bd5c5595%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/7ed0e8eef79b8b08efda8152bd5c5595.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_5():
    "her, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', 'file:/media/movies/Her', "'(2013)/Her'", "'(2013)'", "'[imdbid-tt1798709]'", '-', "'[Remux-1080p][DTS-HD'", 'MA', "'5.1][AVC]-FraMeSToR.mkv'", '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-bsf:v', 'h264_mp4toannexb', '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'cbf314b529746b8d571402c9987a81a4-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/cbf314b529746b8d571402c9987a81a4%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/cbf314b529746b8d571402c9987a81a4.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Her', "'(2013)/Her'", "'(2013)'", "'[imdbid-tt1798709]'", '-', "'[Remux-1080p][DTS-HD'", 'MA', "'5.1][AVC]-FraMeSToR.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=240:format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '7ed0e8eef79b8b08efda8152bd5c5595-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/7ed0e8eef79b8b08efda8152bd5c5595%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/7ed0e8eef79b8b08efda8152bd5c5595.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_6():
    "her, 720p 8mbps, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', 'file:/media/movies/Her', "'(2013)/Her'", "'(2013)'", "'[imdbid-tt1798709]'", '-', "'[Remux-1080p][DTS-HD'", 'MA', "'5.1][AVC]-FraMeSToR.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '7616000', '-maxrate', '7616000', '-bufsize', '15232000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '578d61150dc1d5cb8c42e97079428111-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/578d61150dc1d5cb8c42e97079428111%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/578d61150dc1d5cb8c42e97079428111.m3u8']
    expected = None #unknown
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_7():
    "her, 360p - 420kbps"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', 'file:/media/movies/Her', "'(2013)/Her'", "'(2013)'", "'[imdbid-tt1798709]'", '-', "'[Remux-1080p][DTS-HD'", 'MA', "'5.1][AVC]-FraMeSToR.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=w=426:h=240:format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'e3c01d98b79752bdfe976866ad3a699c-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/e3c01d98b79752bdfe976866ad3a699c%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/e3c01d98b79752bdfe976866ad3a699c.m3u8']
    expected = None #unknown
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_8():
    "hello love goodbye , seek 01:05:09.292"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-ss', '01:04:45.750', '-noaccurate_seek', '-fflags', '+genpts', '-i', 'file:/media/movies/Hello', 'Love', 'Goodbye', "'(2019)'", "'[imdbid-tt10156112]/Hello'", 'Love', 'Goodbye', "'(2019)'", "'[imdbid-tt10156112]'", '-', "'[WEBDL-1080p][AAC'", "'2.0][HEVC]-SH3LBY.mkv'", '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-tag:v:0', 'hvc1', '-bsf:v', 'hevc_mp4toannexb', '-start_at_zero', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '9ea9a4ff2cb4212cdd7ae72604d25c3b-1.mp4', '-start_number', '647', '-hls_segment_filename', '/cache/transcodes/9ea9a4ff2cb4212cdd7ae72604d25c3b%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/9ea9a4ff2cb4212cdd7ae72604d25c3b.m3u8']
    expected = None #uknown
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_9():
    "hello love goodbye, from beggining subrip"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', 'file:/media/movies/Hello', 'Love', 'Goodbye', "'(2019)'", "'[imdbid-tt10156112]/Hello'", 'Love', 'Goodbye', "'(2019)'", "'[imdbid-tt10156112]'", '-', "'[WEBDL-1080p][AAC'", "'2.0][HEVC]-SH3LBY.mkv'", '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-tag:v:0', 'hvc1', '-bsf:v', 'hevc_mp4toannexb', '-start_at_zero', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'ec1c4223feaaf4ca9c0aa9c8d3be323e-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/ec1c4223feaaf4ca9c0aa9c8d3be323e%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/ec1c4223feaaf4ca9c0aa9c8d3be323e.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Hello', 'Love', 'Goodbye', "'(2019)'", "'[imdbid-tt10156112]/Hello'", 'Love', 'Goodbye', "'(2019)'", "'[imdbid-tt10156112]'", '-', "'[WEBDL-1080p][AAC'", "'2.0][HEVC]-SH3LBY.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=230:format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-ar', '48000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'd2c73323cc62e42925c84d3c09224a67-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/d2c73323cc62e42925c84d3c09224a67%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/d2c73323cc62e42925c84d3c09224a67.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_10():
    "hello love goodbye, from beggining no sub (direct play)"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', 'file:/media/movies/Hello', 'Love', 'Goodbye', "'(2019)'", "'[imdbid-tt10156112]/Hello'", 'Love', 'Goodbye', "'(2019)'", "'[imdbid-tt10156112]'", '-', "'[WEBDL-1080p][AAC'", "'2.0][HEVC]-SH3LBY.mkv'", '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-tag:v:0', 'hvc1', '-bsf:v', 'hevc_mp4toannexb', '-start_at_zero', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'f3c6157c144dba5e8c8a3ab23ecd28d2-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/f3c6157c144dba5e8c8a3ab23ecd28d2%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/f3c6157c144dba5e8c8a3ab23ecd28d2.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Hello', 'Love', 'Goodbye', "'(2019)'", "'[imdbid-tt10156112]/Hello'", 'Love', 'Goodbye', "'(2019)'", "'[imdbid-tt10156112]'", '-', "'[WEBDL-1080p][AAC'", "'2.0][HEVC]-SH3LBY.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=230:format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-ar', '48000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '7e55277f705369d7a2785c63eeede60a-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/7e55277f705369d7a2785c63eeede60a%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/7e55277f705369d7a2785c63eeede60a.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_11():
    "mag ingat ka sa kulam , from beginning, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-noautorotate', '-i', 'file:/media/movies/Mag-ingat', 'ka', 'sa.', 'Kulam', "'(2008)/Mag-ingat'", 'ka', 'sa.', 'Kulam', "'(2008)'", "'[imdbid-tt1071223]'", '-', "'[DVD][MP3'", "'2.0][DivX].avi'", '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '5619176', '-maxrate', '5619176', '-bufsize', '11238352', '-g:v:0', '90', '-keyint_min:v:0', '90', '-vf', "'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale=trunc(min(max(iw\\,ih*a)\\,min(720\\,480*a))/2)*2:trunc(min(max(iw/a\\,ih)\\,min(720/a\\,480))/2)*2,format=yuv420p'", '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'b899660835fe0d864fb6568bc09fdd53-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/b899660835fe0d864fb6568bc09fdd53%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/b899660835fe0d864fb6568bc09fdd53.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Mag-ingat', 'ka', 'sa.', 'Kulam', "'(2008)/Mag-ingat'", 'ka', 'sa.', 'Kulam', "'(2008)'", "'[imdbid-tt1071223]'", '-', "'[DVD][MP3'", "'2.0][DivX].avi'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '90', '-keyint_min:v:0', '90', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=284:format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '0fd8fc724ea4888ed314ccacd2cd28e1-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/0fd8fc724ea4888ed314ccacd2cd28e1%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/0fd8fc724ea4888ed314ccacd2cd28e1.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_12():
    "mag ingat ka sa kulam , from beginning, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-noautorotate', '-i', '"file:/media/movies/Mag-ingat ka sa. Kulam (2008)/Mag-ingat ka sa. Kulam (2008) [imdbid-tt1071223] - [DVD][MP3 2.0][DivX].avi"', '-i', '"file:/media/movies/Mag-ingat ka sa. Kulam (2008)/Mag-ingat ka sa. Kulam (2008) [imdbid-tt1071223] - [DVD][MP3 2.0][DivX].sub"', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '1:0', '-sn', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '5619176', '-maxrate', '5619176', '-bufsize', '11238352', '-g:v:0', '90', '-keyint_min:v:0', '90', '-filter_complex', '"[1:0]scale=-1:480:fast_bilinear,scale,crop,pad=max(720\\,iw):max(480\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=720:480[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale=trunc(min(max(iw\\,ih*a)\\,min(720\\,480*a))/2)*2:trunc(min(max(iw/a\\,ih)\\,min(720/a\\,480))/2)*2,format=yuv420p[main];[main][sub]overlay=eof_action=pass:repeatlast=0"', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '86fec5fe19bccb76c0c2bf96fa7e1055-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/86fec5fe19bccb76c0c2bf96fa7e1055%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/86fec5fe19bccb76c0c2bf96fa7e1055.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Mag-ingat ka sa. Kulam (2008)/Mag-ingat ka sa. Kulam (2008) [imdbid-tt1071223] - [DVD][MP3 2.0][DivX].avi"', '-i', '"file:/media/movies/Mag-ingat ka sa. Kulam (2008)/Mag-ingat ka sa. Kulam (2008) [imdbid-tt1071223] - [DVD][MP3 2.0][DivX].sub"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '1:0', '-sn', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '90', '-keyint_min:v:0', '90', '-filter_complex', '"[1:0]scale=-1:284:fast_bilinear,scale,crop,pad=max(426\\,iw):max(284\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=426:284,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=284:format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0"', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '86fec5fe19bccb76c0c2bf96fa7e1055-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/86fec5fe19bccb76c0c2bf96fa7e1055%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/86fec5fe19bccb76c0c2bf96fa7e1055.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_13():
    "bean, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', 'file:/media/movies/Bean', "'(1997)'", "'[imdbid-tt0118689]/Bean'", "'(1997)'", "'[imdbid-tt0118689]'", '-', "'[Remux-1080p][DTS-HD'", 'MA', "'5.1][VC1]-SiCFoI.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '35342324', '-maxrate', '35342324', '-bufsize', '70684648', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '328008628ad6cd2f13036d7c93110d71-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/328008628ad6cd2f13036d7c93110d71%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/328008628ad6cd2f13036d7c93110d71.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Bean', "'(1997)'", "'[imdbid-tt0118689]/Bean'", "'(1997)'", "'[imdbid-tt0118689]'", '-', "'[Remux-1080p][DTS-HD'", 'MA', "'5.1][VC1]-SiCFoI.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '35342324', '-maxrate', '35342324', '-bufsize', '70684648', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '328008628ad6cd2f13036d7c93110d71-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/328008628ad6cd2f13036d7c93110d71%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/328008628ad6cd2f13036d7c93110d71.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

    
def test_translate_harware_acceleration_args_14():
    "bean, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Bean (1997) [imdbid-tt0118689]/Bean (1997) [imdbid-tt0118689] - [Remux-1080p][DTS-HD MA 5.1][VC1]-SiCFoI.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '35342324', '-maxrate', '35342324', '-bufsize', '70684648', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:2]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=1920:h=1080'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '85f37ec2eeebac6d245a1e3fa6379fab-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/85f37ec2eeebac6d245a1e3fa6379fab%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/85f37ec2eeebac6d245a1e3fa6379fab.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Bean (1997) [imdbid-tt0118689]/Bean (1997) [imdbid-tt0118689] - [Remux-1080p][DTS-HD MA 5.1][VC1]-SiCFoI.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '35342324', '-maxrate', '35342324', '-bufsize', '70684648', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:2]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '85f37ec2eeebac6d245a1e3fa6379fab-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/85f37ec2eeebac6d245a1e3fa6379fab%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/85f37ec2eeebac6d245a1e3fa6379fab.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_15():
    "cinema paradiso, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', 'file:/media/movies/Cinema', 'Paradiso', "'(1988)/Cinema'", 'Paradiso', "'(1988)'", "'[imdbid-tt0095765]'", '-', 'Theatrical', 'Cut', "'[Remux-2160p][HDR10][DTS-HD'", 'MA', "'5.1][HEVC]-FraMeSToR.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '93145521', '-maxrate', '93145521', '-bufsize', '186291042', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '744877247b05cb916ab624b1483921c1-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/744877247b05cb916ab624b1483921c1%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/744877247b05cb916ab624b1483921c1.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Cinema', 'Paradiso', "'(1988)/Cinema'", 'Paradiso', "'(1988)'", "'[imdbid-tt0095765]'", '-', 'Theatrical', 'Cut', "'[Remux-2160p][HDR10][DTS-HD'", 'MA', "'5.1][HEVC]-FraMeSToR.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=240:format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '7fa64862d68530bffe7726705851fcc4-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/7fa64862d68530bffe7726705851fcc4%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/7fa64862d68530bffe7726705851fcc4.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_16():
    "cinema paradiso, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', '"file:/media/movies/Cinema Paradiso (1988)/Cinema Paradiso (1988) [imdbid-tt0095765] - Theatrical Cut [Remux-2160p][HDR10][DTS-HD MA 5.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '93145521', '-maxrate', '93145521', '-bufsize', '186291042', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=3840:h=2160'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '10f7d690c1f6e0953957c5bcd35ebe3c-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/10f7d690c1f6e0953957c5bcd35ebe3c%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/10f7d690c1f6e0953957c5bcd35ebe3c.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', '"file:/media/movies/Cinema Paradiso (1988)/Cinema Paradiso (1988) [imdbid-tt0095765] - Theatrical Cut [Remux-2160p][HDR10][DTS-HD MA 5.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '93145521', '-maxrate', '93145521', '-bufsize', '186291042', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:4]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\,iw):max(2160\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '10f7d690c1f6e0953957c5bcd35ebe3c-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/10f7d690c1f6e0953957c5bcd35ebe3c%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/10f7d690c1f6e0953957c5bcd35ebe3c.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_17():
    "luca, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Luca (2021) [imdbid-tt12801262]/Luca (2021) [imdbid-tt12801262] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '59446607', '-maxrate', '59446607', '-bufsize', '118893214', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=3840:h=2160'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '8cbb6e9215e0d94ac70d21d0e0cd379b-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/8cbb6e9215e0d94ac70d21d0e0cd379b%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/d0ea8675ca9c0e96214a072ee2b2ff50.m3u8']
    #do not change this, it is the expected result
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Luca (2021) [imdbid-tt12801262]/Luca (2021) [imdbid-tt12801262] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '59446607', '-maxrate', '59446607', '-bufsize', '118893214', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '8cbb6e9215e0d94ac70d21d0e0cd379b-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/8cbb6e9215e0d94ac70d21d0e0cd379b%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/d0ea8675ca9c0e96214a072ee2b2ff50.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_18():
    "luca 1080p 60mbps, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Luca (2021) [imdbid-tt12801262]/Luca (2021) [imdbid-tt12801262] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '59446607', '-maxrate', '59446607', '-bufsize', '118893214', '-profile:v:0', 'main', '-level', '50', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=3840:h=2160'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '10ddb9c0a7a53192c0b7fe5425ba8ec9-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/10ddb9c0a7a53192c0b7fe5425ba8ec9%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/10ddb9c0a7a53192c0b7fe5425ba8ec9.m3u8']
    #do not change this
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', '"file:/media/movies/Luca (2021) [imdbid-tt12801262]/Luca (2021) [imdbid-tt12801262] - [Remux-2160p][DV HDR10][TrueHD Atmos 7.1][HEVC]-FraMeSToR.mkv"', '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '59446607', '-maxrate', '59446607', '-bufsize', '118893214', '-profile:v:0', 'main', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:2160:fast_bilinear,scale,crop,pad=max(3840\\,iw):max(2160\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=3840:2160,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '10ddb9c0a7a53192c0b7fe5425ba8ec9-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/10ddb9c0a7a53192c0b7fe5425ba8ec9%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/10ddb9c0a7a53192c0b7fe5425ba8ec9.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_19():
    "letters to juliet (direct play)"
    input_args = None #there was none- double check
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Letters', 'to', 'Juliet', "'(2010)'", "'[imdbid-tt0892318]/Letters'", 'to', 'Juliet', "'(2010)'", "'[imdbid-tt0892318]'", '-', "'[Bluray-1080p][AAC'", "'2.0][x264]-1080p.mp4'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '324063', '-maxrate', '324063', '-bufsize', '648126', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=180:format=yuv420p', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '6705382c8b021dc8d7cc29325517b301-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/6705382c8b021dc8d7cc29325517b301%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/6705382c8b021dc8d7cc29325517b301.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_20():
    "letters to juliet 320p"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', 'file:/media/movies/Letters', 'to', 'Juliet', "'(2010)'", "'[imdbid-tt0892318]/Letters'", 'to', 'Juliet', "'(2010)'", "'[imdbid-tt0892318]'", '-', "'[Bluray-1080p][AAC'", "'2.0][x264]-1080p.mp4'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '324063', '-maxrate', '324063', '-bufsize', '648126', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=w=426:h=180:format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'copy', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'ae06a5a3b1ff5df87e813f857aa7c13b-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/ae06a5a3b1ff5df87e813f857aa7c13b%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/ae06a5a3b1ff5df87e813f857aa7c13b.m3u8']
    expected = None #unknown
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_21():
    "cube 320p, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', 'file:/media/movies/Cube', "'(1997)/Cube'", "'(1997)'", "'[imdbid-tt0123755]'", '-', "'[Remux-1080p][TrueHD'", "'5.1][AVC]-KRaLiMaRKo.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=w=426:h=240:format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '935be825c3d0edcf94e79ec32582126e-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/935be825c3d0edcf94e79ec32582126e%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/935be825c3d0edcf94e79ec32582126e.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Cube', "'(1997)/Cube'", "'(1997)'", "'[imdbid-tt0123755]'", '-', "'[Remux-1080p][TrueHD'", "'5.1][AVC]-KRaLiMaRKo.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-vf', 'setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=w=426:h=240:format=yuv420p', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'fc6f51469cdbab924fb9d453e4cdf601-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/fc6f51469cdbab924fb9d453e4cdf601%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/fc6f51469cdbab924fb9d453e4cdf601.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_22():
    "cube 360p, pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', 'file:/media/movies/Cube', "'(1997)/Cube'", "'(1997)'", "'[imdbid-tt0123755]'", '-', "'[Remux-1080p][TrueHD'", "'5.1][AVC]-KRaLiMaRKo.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '292000', '-maxrate', '292000', '-bufsize', '584000', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:240:fast_bilinear,scale,crop,pad=max(426\\,iw):max(240\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=426:240,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=w=426:h=240:format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=426:h=240'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '128000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '04bc74fe4ffc1bea751db0dee94acce1-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/04bc74fe4ffc1bea751db0dee94acce1%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/04bc74fe4ffc1bea751db0dee94acce1.m3u8']
    expected = None #unknown
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_23():
    "cube, no sub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', 'file:/media/movies/Cube', "'(1997)/Cube'", "'(1997)'", "'[imdbid-tt0123755]'", '-', "'[Remux-1080p][TrueHD'", "'5.1][AVC]-KRaLiMaRKo.mkv'", '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-bsf:v', 'h264_mp4toannexb', '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '25c45f98cf4bc195d3c4cea97ce7e8cf-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/25c45f98cf4bc195d3c4cea97ce7e8cf%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/25c45f98cf4bc195d3c4cea97ce7e8cf.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-fflags', '+genpts', '-i', 'file:/media/movies/Cube', "'(1997)/Cube'", "'(1997)'", "'[imdbid-tt0123755]'", '-', "'[Remux-1080p][TrueHD'", "'5.1][AVC]-KRaLiMaRKo.mkv'", '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:s', '-codec:v:0', 'copy', '-bsf:v', 'h264_mp4toannexb', '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '6', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '2441cf74e1c4db1dc45ec655247eb758-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/2441cf74e1c4db1dc45ec655247eb758%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/2441cf74e1c4db1dc45ec655247eb758.m3u8']  
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_24():
    "cube ,english pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-canvas_size', '1920x1080', '-i', 'file:/media/movies/Cube', "'(1997)/Cube'", "'(1997)'", "'[imdbid-tt0123755]'", '-', "'[Remux-1080p][TrueHD'", "'5.1][AVC]-KRaLiMaRKo.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '36401060', '-maxrate', '36401060', '-bufsize', '72802120', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=1920:h=1080'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '7f09b116c41d229e5ad24f86cabefda7-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/7f09b116c41d229e5ad24f86cabefda7%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/7f09b116c41d229e5ad24f86cabefda7.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-canvas_size', '1920x1080', '-i', 'file:/media/movies/Cube', "'(1997)/Cube'", "'(1997)'", "'[imdbid-tt0123755]'", '-', "'[Remux-1080p][TrueHD'", "'5.1][AVC]-KRaLiMaRKo.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '36401060', '-maxrate', '36401060', '-bufsize', '72802120', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:3]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', 'c29968c8637d55a92539359c7b193c13-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/c29968c8637d55a92539359c7b193c13%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/c29968c8637d55a92539359c7b193c13.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected
    
def test_translate_harware_acceleration_args_25():
    "cube ,japanese pgsub"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'vaapi=va:,kernel_driver=i915,driver=iHD', '-init_hw_device', 'qsv=qs@va', '-filter_hw_device', 'qs', '-hwaccel', 'vaapi', '-hwaccel_output_format', 'vaapi', '-noautorotate', '-i', 'file:/media/movies/Cube', "'(1997)/Cube'", "'(1997)'", "'[imdbid-tt0123755]'", '-', "'[Remux-1080p][TrueHD'", "'5.1][AVC]-KRaLiMaRKo.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_qsv', '-tag:v:0', 'hvc1', '-preset', 'veryfast', '-b:v', '36401060', '-maxrate', '36401060', '-bufsize', '72802120', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:6]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=bgra,hwupload=derive_device=qsv:extra_hw_frames=64[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_vaapi=format=nv12:extra_hw_frames=24,hwmap=derive_device=qsv,format=qsv[main];[main][sub]overlay_qsv=eof_action=pass:repeatlast=0:w=1920:h=1080'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '3f5d402f6526ac97eeefab76da9abdcd-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/3f5d402f6526ac97eeefab76da9abdcd%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/3f5d402f6526ac97eeefab76da9abdcd.m3u8']
    expected = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-analyzeduration', '200M', '-probesize', '1G', '-init_hw_device', 'cuda=cu:0', '-filter_hw_device', 'cu', '-hwaccel', 'cuda', '-hwaccel_output_format', 'cuda', '-hwaccel_flags', '+unsafe_output', '-threads', '1', '-noautorotate', '-i', 'file:/media/movies/Cube', "'(1997)/Cube'", "'(1997)'", "'[imdbid-tt0123755]'", '-', "'[Remux-1080p][TrueHD'", "'5.1][AVC]-KRaLiMaRKo.mkv'", '-noautoscale', '-map_metadata', '-1', '-map_chapters', '-1', '-threads', '0', '-map', '0:0', '-map', '0:1', '-map', '-0:0', '-codec:v:0', 'hevc_nvenc', '-tag:v:0', 'hvc1', '-preset', 'p1', '-b:v', '36401060', '-maxrate', '36401060', '-bufsize', '72802120', '-g:v:0', '72', '-keyint_min:v:0', '72', '-filter_complex', "'[0:6]scale=-1:1080:fast_bilinear,scale,crop,pad=max(1920\\,iw):max(1080\\,ih):(ow-iw)/2:(oh-ih)/2:black@0,crop=1920:1080,format=yuva420p,hwupload=derive_device=cuda[sub];[0:0]setparams=color_primaries=bt709:color_trc=bt709:colorspace=bt709,scale_cuda=format=yuv420p[main];[main][sub]overlay_cuda=eof_action=pass:repeatlast=0'", '-start_at_zero', '-codec:a:0', 'libfdk_aac', '-ac', '2', '-ab', '256000', '-af', 'volume=2', '-copyts', '-avoid_negative_ts', 'disabled', '-max_muxing_queue_size', '2048', '-f', 'hls', '-max_delay', '5000000', '-hls_time', '3', '-hls_segment_type', 'fmp4', '-hls_fmp4_init_filename', '899c4735adf660792b53b54166cb6056-1.mp4', '-start_number', '0', '-hls_segment_filename', '/cache/transcodes/899c4735adf660792b53b54166cb6056%d.mp4', '-hls_playlist_type', 'vod', '-hls_list_size', '0', '-y', '/cache/transcodes/899c4735adf660792b53b54166cb6056.m3u8']
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected

def test_translate_harware_acceleration_args_26():
    "misc"
    input_args = ['/usr/lib/jellyfin-ffmpeg/ffmpeg', '-dump_attachment:t', '-y', '-i', 'file:/media/movies/Cinema', 'Paradiso', "'(1988)/Cinema'", 'Paradiso', "'(1988)'", "'[imdbid-tt0095765]'", '-', 'Theatrical', 'Cut', "'[Remux-2160p][HDR10][DTS-HD'", 'MA', "'5.1][HEVC]-FraMeSToR.mkv'", '-t', '0', '-f', 'null', 'null']
    expected = None #Unknown
    result = rffmpeg.translate_harware_acceleration_args(input_args)
    assert result == expected